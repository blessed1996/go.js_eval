<!DOCTYPE html>
  <html lang="en">
<head>
    <script src="https://unpkg.com/gojs@2.3.12/release/go.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
  <body>
  
  <div id="allSampleContent" class="p-4 w-full">
<style type="text/css">
      .draggable {
        display: inline-block;
        vertical-align: top;
        border: 4px solid #BBB;
        border-radius: 4px;
        background-color: #F5F5F5;
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 500;
      }

      .handle {
        background-color: lightblue;
        cursor: move;
        text-align: center;
        font: bold 12px sans-serif;
      }

      #infoDraggable {
        font: 12px helvetica, sans-serif;
        min-width: 213px;
      }

      #myInfo {
        width: 100%;
        overflow: hidden;
      }

      #myPaletteDiv {
        background-color: #F5F5F5;
        width: 100%;
        height: 100%;
      }

      /*
  One simple way of making a div fill its space,
  with allowances for the title (top) and the resize handle (bottom)
  */
      #paletteContainer {
        position: absolute;
        bottom: 14px;
        left: 0px;
        right: 0px;
        top: 14px;
      }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

<script id="code">
  function init() {
    if (window.goSamples) goSamples();

    var co = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram =
      co(go.Diagram, "myDiagramDiv",
        { "undoManager.isEnabled": true });

    // define several shared Brushes
    var fill1 = "rgb(105,210,231)"
    var brush1 = "rgb(65,180,181)";

    var fill2 = "rgb(167,219,216)"
    var brush2 = "rgb(127,179,176)";

    var fill3 = "rgb(224,228,204)"
    var brush3 = "rgb(184,188,164)";

    var fill4 = "rgb(243,134,48)"
    var brush4 = "rgb(203,84,08)";

    myDiagram.nodeTemplateMap.add("actor", co(go.Node, "Spot",
          co(go.Panel, "Auto",
              co(go.Shape, "Circle", { fill: "white", portId: "", fromLinkable: true, toLinkable: true, cursor: "pointer", desiredSize: new go.Size(75, 75) }),
              co(go.Picture,
                  { margin: 10, width: 50, height: 50 },
                  new go.Binding("source", "icon")
              )
          ),
          co(go.TextBlock,
              { alignment: go.Spot.Bottom, margin: 5, editable: true },
              new go.Binding("text", "key").makeTwoWay()
          )
      ));

      myDiagram.nodeTemplateMap.add("workobject", co(go.Node, "Spot",
          co(go.Panel, "Auto",
              co(go.Shape, "Circle", { fill: "white", portId: "", fromLinkable: true, toLinkable: true, cursor: "pointer", desiredSize: new go.Size(75, 75) }),
              co(go.Picture,
                  { margin: 10, width: 50, height: 50 },
                  new go.Binding("source", "icon")
              )
          ),
          co(go.TextBlock,
              { alignment: go.Spot.Bottom, margin: 5, editable: true },
              new go.Binding("text", "key").makeTwoWay()
          )
      ));

    myDiagram.nodeTemplateMap.add("textbox", // textbox category, to implement rules
      co(go.Node, "Auto",
        { locationSpot: go.Spot.Center, portId: "", fromLinkable: false, toLinkable: false  },
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        co(go.Shape, "Rectangle",
          { strokeWidth: 0, fill: "white", name: "SHAPE" },
          new go.Binding("figure", "figure"),
          new go.Binding("fill", "fill"),
          new go.Binding("stroke", "stroke")
        ),
        co(go.TextBlock,
          {
            margin: 5,
            maxSize: new go.Size(200, NaN),
            wrap: go.TextBlock.WrapFit,
            textAlign: "center",
            editable: true,
            font: "bold 9pt Helvetica, Arial, sans-serif",
            name: "insert text here",
            // movable: true,
          },
          new go.Binding("text", "text").makeTwoWay())));

    // Define a simple node template for the frames
myDiagram.nodeTemplateMap.add("frame",  // custom category for frame nodes
    co(go.Node, "Auto", { layerName: "Background", resizable: true, resizeObjectName: "SHAPE" },
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        co(go.Shape, "Rectangle",  // the shape of the node
        {
            name: "SHAPE",
            fill: "lightgray",  // default color
            stroke: "transparent",
            strokeWidth: 0,
            portId: "", fromLinkable: true, toLinkable: true, cursor: "pointer"
        },
        new go.Binding("fill", "color")),  // binding for changing the color
        co(go.TextBlock, { margin: 8, editable: true },
        new go.Binding("text").makeTwoWay())
    )
    );

    myDiagram.toolManager.linkingTool.linkValidation = function(fromnode, fromport, tonode, toport) {
  // Check if both nodes are actors
  if (fromnode.category === "actor" && tonode.category === "actor") {
    // Display the warning message in the custom div instead of using alert
    var warningDiv = document.getElementById("linkWarning");
    warningDiv.style.display = "block";
    // Optionally, hide the warning after a few seconds
    setTimeout(function() {
        warningDiv.style.display = "none";
    }, 5000);
    return false;
}
  
  // Allow linking from Actor to WorkObject and WorkObject to WorkObject
  if ((fromnode.category === "actor" && tonode.category === "workobject") ||
      (fromnode.category === "workobject" && tonode.category === "workobject") ||
      (fromnode.category === "workobject" && tonode.category === "actor")) {
    return true;
  }
  
  // By default, do not allow linking
  return false;
};

myDiagram.linkTemplate =
  co(go.Link,  // the whole link panel
    { relinkableFrom: true, relinkableTo: true, reshapable: true },  // allow users to relink and reshape links
    co(go.Shape,  // the link shape
      { strokeWidth: 2 }),
    co(go.Shape,  // the arrowhead
      { toArrow: "Standard", stroke: null }),
    co(go.Panel, "Auto",
      co(go.Shape,  // the label background, which becomes visible when there is a label
        { fill: co(go.Brush, "Radial", { 0: "rgb(240, 240, 240)", 0.3: "rgb(240, 240, 240)", 1: "rgb(240, 240, 240)" }),
          stroke: null }),
      co(go.TextBlock, "new link",  // the label text
        {
          textAlign: "center",
          font: "10pt helvetica, arial, sans-serif",
          stroke: "#555555",
          margin: 4,
          editable: true  // enable in-place editing
        },
        // Two-way data binding for text editing
        new go.Binding("text", "text").makeTwoWay())
    )
  );
    
// Adjusting the linking tool's handle archetypes - currently not working anymore, needs fixing
myDiagram.toolManager.linkingTool.fromHandleArchetype = 
      go.GraphObject.make(go.Shape, "Diamond", {
          desiredSize: new go.Size(15, 15),
          stroke: "green",
          fill: "lime"
      });

    myDiagram.toolManager.linkingTool.toHandleArchetype = 
      go.GraphObject.make(go.Shape, "Diamond", {
          desiredSize: new go.Size(15, 15),
          stroke: "red",
          fill: "pink"
      });

    myDiagram.toolManager.relinkingTool.fromHandleArchetype = 
      go.GraphObject.make(go.Shape, "Diamond", {
          desiredSize: new go.Size(15, 15),
          stroke: "green",
          fill: "lime"
      });

    myDiagram.toolManager.relinkingTool.toHandleArchetype = 
      go.GraphObject.make(go.Shape, "Diamond", {
          desiredSize: new go.Size(15, 15),
          stroke: "red",
          fill: "pink"
      });

    // initialize the Palette that is in a floating, draggable HTML container
    myPalette = new go.Palette("myPaletteDiv");  // must name or refer to the DIV HTML element
    myPalette.nodeTemplateMap = myDiagram.nodeTemplateMap;
    myPalette.model = new go.GraphLinksModel([
      { category: "actor", figure: "Circle", icon: "icons/256x256/senior_citizen.png" },
      /* { text: "Actor 2", fill: fill2, stroke: brush2, figure: "Rectangle" }, */
      { category: "workobject", figure: "Circle", icon: "icons/256x256/airplane.png" },
      /* { text: "Werkobjekt 2", fill: fill4, stroke: brush4, figure: "Rectangle" } */
      { category: "textbox", text: "Textbox 1", fill: fill3, stroke: brush3, figure: "Rectangle" },
      // add frame
      { category: "frame", text: "Frame", color: "lightgray" }
    ]);

    myPalette.addDiagramListener("InitialLayoutCompleted", diagramEvent => {
      var pdrag = document.getElementById("paletteDraggable");
      var palette = diagramEvent.diagram;
      pdrag.style.width = palette.documentBounds.width + 28 + "px"; // account for padding/borders
      pdrag.style.height = palette.documentBounds.height + 38 + "px";
    });

    $(() => {
      $("#paletteDraggable").draggable({ handle: "#paletteDraggableHandle" }).resizable({
        // After resizing, perform another layout to fit everything in the palette's viewport
        stop: () => myPalette.layoutDiagram(true)
      });

      var inspector = new Inspector('myInfo', myDiagram,
        {
          properties: {
            // key would be automatically added for nodes, but we want to declare it read-only also:
            "key": { readOnly: true, show: Inspector.showIfPresent },
            // fill and stroke would be automatically added for nodes, but we want to declare it a color also:
            "fill": { show: Inspector.showIfPresent, type: 'color' },
            "stroke": { show: Inspector.showIfPresent, type: 'color' }
          }
        });
    });

    // Initialize counters for actor and workobject naming
let actorCounter = 1;
let workobjectCounter = 1;

myDiagram.addDiagramListener("ExternalObjectsDropped", function(e) {
  var incrementCounters = {
    "actor": function(n) { return "Actor " + actorCounter++; },
    "workobject": function(n) { return "Workobject " + workobjectCounter++; }
  };

  e.subject.each(function(part) {
    if (part instanceof go.Node && incrementCounters[part.category]) {
      var newName = incrementCounters[part.category](part.data.key);
      myDiagram.model.startTransaction("rename node");
      myDiagram.model.setDataProperty(part.data, "key", newName);
      myDiagram.model.commitTransaction("rename node");
    }
  });
});

myDiagram.addDiagramListener("ChangedSelection", function(e) {
    var node = myDiagram.selection.first();
    if (node instanceof go.Node) {
        document.getElementById("iconEditor").style.display = "block";
        document.getElementById("iconUrl").value = node.data.icon || "";
    } else {
        document.getElementById("iconEditor").style.display = "none";
    }
});

}

/*
function to edit the icon of a already existing object. Currently, the root of the file has to be written manually.
To be able to implement a dropdown menu you would typically need server-side support to list the files in that directory,
because JavaScript running in the browser does not have direct access to the file system directories
*/
function changeIcon() {
    var node = myDiagram.selection.first();
    if (node !== null) {
        var newIconUrl = document.getElementById("iconUrl").value;
        // Update the node data, which automatically updates the diagram due to data binding
        myDiagram.model.startTransaction("change icon");
        myDiagram.model.setDataProperty(node.data, "icon", newIconUrl);
        myDiagram.model.commitTransaction("change icon");
    }
}

function changeFrameColor() {
  var node = myDiagram.selection.first();
  if (node !== null && node.category === "frame") {
    // Open a simple color picker, then update the node's color
    var newColor = prompt("Enter a new color:", node.data.color || "lightgray");
    if (newColor !== null) {
      myDiagram.startTransaction("change color");
      myDiagram.model.setDataProperty(node.data, "color", newColor);
      myDiagram.commitTransaction("change color");
    }
  }
}

  window.addEventListener('DOMContentLoaded', init);
</script>

<div id="sample">

    <div id="paletteDraggable" class="draggable ui-draggable ui-resizable" style="height: 233.857px; width: 123.81px;">
      <div id="paletteDraggableHandle" class="handle ui-draggable-handle">Palette</div>
      <div id="paletteContainer">
        <div id="myPaletteDiv" style="position: relative; cursor: auto;"><canvas tabindex="0" style="position: absolute; top: 0px; left: 0px; z-index: 2; user-select: none; touch-action: none; width: 116px; height: 198px; cursor: auto;" width="232" height="396"></canvas><div style="position: absolute; overflow: auto; width: 116px; height: 198px; z-index: 1;"><div style="position: absolute; width: 1px; height: 1px;"></div></div></div>
      </div>
    <div class="ui-resizable-handle ui-resizable-e" style="z-index: 90;"></div><div class="ui-resizable-handle ui-resizable-s" style="z-index: 90;"></div><div class="ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se" style="z-index: 90;"></div></div>

    <div style="display: inline-block; vertical-align: top; width:400px">
      <div id="myDiagramDiv" style="background-color: whitesmoke; border: 1px solid black; height: 600px; width: 1200px; position: relative; cursor: auto; font: bold 9pt Helvetica, Arial, sans-serif;"><canvas tabindex="0" style="position: absolute; top: 0px; left: 0px; z-index: 2; user-select: none; touch-action: none; width: 398px; height: 398px; cursor: auto;" width="796" height="796"></canvas><div style="position: absolute; overflow: auto; width: 398px; height: 398px; z-index: 1;"><div style="position: absolute; width: 1px; height: 1px;"></div></div></div>
    </div>

    <div id="iconEditor" style="display:none;">
        <label for="iconUrl">Icon URL:</label>
        <input type="text" id="iconUrl" name="iconUrl">
        <button onclick="changeIcon()">Change Icon</button>
    </div>    

    <button onclick="changeFrameColor()">Change Frame Color</button>

    <!-- Warning for illegal linking -->
    <div id="linkWarning" style="display: none; color: red; position: absolute; top: 100px; right: 20px; padding: 10px; background-color: white; border: 1px solid red; border-radius: 5px; z-index: 1000;">
        <i class="fas fa-exclamation-triangle"></i> Actors cannot be linked to other actors.
    </div>    

  </body>
  </html>